<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الطلاب - لوحة الطالب</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #1877f2;
            --secondary-color: #42b72a;
            --dark-color: #1c1e21;
            --light-color: #f0f2f5;
            --gray-color: #65676b;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --border-radius: 8px;
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        /* Layout */
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: white;
            box-shadow: var(--box-shadow);
            position: fixed;
            height: 100vh;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .sidebar-header h3 {
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .sidebar-menu li {
            list-style: none;
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 10px 20px;
            color: var(--gray-color);
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: var(--light-color);
            color: var(--primary-color);
            border-right: 3px solid var(--primary-color);
        }
        
        .sidebar-menu i {
            margin-left: 10px;
            font-size: 1.2rem;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-right: 250px;
            transition: all 0.3s;
        }
        
        /* Navbar */
        .navbar {
            background-color: white;
            padding: 15px 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
        }
        
        .navbar-right {
            display: flex;
            align-items: center;
        }
        
        .navbar-search {
            position: relative;
            margin-right: 15px;
        }
        
        .navbar-search input {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            width: 200px;
            outline: none;
        }
        
        .navbar-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        .navbar-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .navbar-profile img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .navbar-profile span {
            font-weight: 500;
        }
        
        /* Content */
        .content {
            padding: 20px;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-header h2 {
            font-size: 1.5rem;
            color: var(--dark-color);
        }
        
        .btn {
            padding: 8px 15px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #166fe5;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #36a420;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        /* Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-header h3 {
            font-size: 1.1rem;
        }
        
        .card-body {
            margin-bottom: 15px;
        }
        
        .card-footer {
            border-top: 1px solid #eee;
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .table th, .table td {
            padding: 12px 15px;
            text-align: right;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .table tr:hover {
            background-color: #f1f1f1;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            outline: none;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            overflow-y: auto;
        }
        
        .modal-dialog {
            background-color: white;
            margin: 50px auto;
            width: 90%;
            max-width: 600px;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.3rem;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
        }
        
        .close {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: var(--gray-color);
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                margin-right: -250px;
            }
            
            .sidebar.active {
                margin-right: 0;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .navbar-toggle {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            .cards {
                grid-template-columns: 1fr;
            }
            
            .navbar-search {
                display: none;
            }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #166fe5;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-color);
        }
        
        .login-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--gray-color);
        }
        
        .login-footer a {
            color: var(--primary-color);
        }
        
        /* Alert */
        .alert {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .alert i {
            margin-left: 10px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Calendar */
        .calendar {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
        }
        
        .calendar-body {
            padding: 10px;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: var(--border-radius);
            cursor: pointer;
        }
        
        .calendar-day:hover {
            background-color: var(--light-color);
        }
        
        .calendar-day.today {
            background-color: var(--primary-color);
            color: white;
        }
        
        .calendar-day.event {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .calendar-day.other-month {
            color: var(--gray-color);
            opacity: 0.5;
        }
        
        /* Timeline */
        .timeline {
            position: relative;
            padding-right: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            right: 15px;
            width: 2px;
            height: 100%;
            background-color: var(--primary-color);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            top: 5px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 2px solid white;
        }
        
        .timeline-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .timeline-date {
            font-size: 0.8rem;
            color: var(--gray-color);
            margin-bottom: 5px;
        }
        
        /* Custom CSS for student interface */
        .profile-card {
            text-align: center;
            padding: 20px;
        }
        
        .profile-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
            border: 3px solid var(--primary-color);
        }
        
        .profile-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .profile-id {
            color: var(--gray-color);
            margin-bottom: 15px;
        }
        
        .profile-details {
            text-align: right;
            margin-top: 20px;
        }
        
        .profile-details p {
            margin-bottom: 10px;
        }
        
        .profile-details i {
            margin-left: 10px;
            color: var(--primary-color);
        }
        
        .class-card {
            position: relative;
            overflow: hidden;
        }
        
        .class-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
        }
        
        .payment-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .payment-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #18191a;
            color: #e4e6eb;
        }
        
        body.dark-mode .sidebar,
        body.dark-mode .navbar,
        body.dark-mode .card,
        body.dark-mode .modal-dialog,
        body.dark-mode .login-card,
        body.dark-mode .timeline-content,
        body.dark-mode .table {
            background-color: #242526;
            color: #e4e6eb;
        }
        
        body.dark-mode .sidebar-menu a:hover,
        body.dark-mode .sidebar-menu a.active {
            background-color: #3a3b3c;
        }
        
        body.dark-mode .table tr:nth-child(even) {
            background-color: #3a3b3c;
        }
        
        body.dark-mode .table tr:hover {
            background-color: #4e4f50;
        }
        
        body.dark-mode .form-control {
            background-color: #3a3b3c;
            border-color: #4e4f50;
            color: #e4e6eb;
        }
        
        body.dark-mode .form-control:focus {
            background-color: #3a3b3c;
            border-color: var(--primary-color);
        }
        
        body.dark-mode .modal-header,
        body.dark-mode .modal-footer {
            border-color: #4e4f50;
        }
        
        body.dark-mode .alert-success {
            background-color: #155724;
            color: #d4edda;
        }
        
        body.dark-mode .alert-danger {
            background-color: #721c24;
            color: #f8d7da;
        }
        
        body.dark-mode .alert-warning {
            background-color: #856404;
            color: #fff3cd;
        }
        
        body.dark-mode .alert-info {
            background-color: #0c5460;
            color: #d1ecf1;
        }
        
        body.dark-mode .profile-details i {
            color: var(--secondary-color);
        }
        
        /* Print Styles */
        @media print {
            .navbar, .sidebar {
                display: none;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .no-print {
                display: none;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h2>تسجيل الدخول للطالب</h2>
                <p>الرجاء إدخال بيانات الاعتماد الخاصة بك</p>
            </div>
            <div id="login-alert" class="alert alert-danger" style="display: none;"></div>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">اسم المستخدم</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">كلمة المرور</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block" id="login-btn">
                    <span id="login-text">تسجيل الدخول</span>
                    <span id="login-spinner" class="spinner" style="display: none;"></span>
                </button>
            </form>
            <div class="login-footer">
                <p>ليس لديك حساب؟ <a href="#" id="show-register">تسجيل طلب انضمام</a></p>
            </div>
        </div>
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="login-header">
                <h2>طلب انضمام جديد</h2>
                <p>املأ النموذج لتقديم طلب الانضمام</p>
            </div>
            <div id="register-alert" class="alert" style="display: none;"></div>
            <form id="register-form">
                <div class="form-group">
                    <label for="name">اسم الطالب الكامل</label>
                    <input type="text" id="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="birthDate">تاريخ الميلاد</label>
                    <input type="date" id="birthDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="academicYear">السنة الدراسية</label>
                    <select id="academicYear" class="form-control" required>
                        <option value="">اختر السنة الدراسية</option>
                        <option value="1AS">الأولى ثانوي</option>
                        <option value="2AS">الثانية ثانوي</option>
                        <option value="3AS">الثالثة ثانوي</option>
                        <option value="1MS">الأولى متوسط</option>
                        <option value="2MS">الثانية متوسط</option>
                        <option value="3MS">الثالثة متوسط</option>
                        <option value="4MS">الرابعة متوسط</option>
                        <option value="5MS">الخامسة متوسط</option>
                        <option value="1AP">الأولى ابتدائي</option>
                        <option value="2AP">الثانية ابتدائي</option>
                        <option value="3AP">الثالثة ابتدائي</option>
                        <option value="4AP">الرابعة ابتدائي</option>
                        <option value="5AP">الخامسة ابتدائي</option>
                        <option value="NS">غير محدد</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parentName">اسم ولي الأمر</label>
                    <input type="text" id="parentName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="parentPhone">هاتف ولي الأمر</label>
                    <input type="tel" id="parentPhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="parentEmail">بريد ولي الأمر (اختياري)</label>
                    <input type="email" id="parentEmail" class="form-control">
                </div>
                <div class="form-group">
                    <label for="address">العنوان</label>
                    <textarea id="address" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="previousSchool">المدرسة السابقة (اختياري)</label>
                    <input type="text" id="previousSchool" class="form-control">
                </div>
                <div class="form-group">
                    <label for="healthInfo">معلومات صحية مهمة (اختياري)</label>
                    <textarea id="healthInfo" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-group no-print">
                    <button type="submit" class="btn btn-secondary btn-block" id="register-btn">
                        <span id="register-text">إرسال الطلب</span>
                        <span id="register-spinner" class="spinner" style="display: none;"></span>
                    </button>
                    <button type="button" class="btn btn-danger btn-block mt-2" id="cancel-register">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>نظام إدارة الطلاب</h3>
                <i class="fas fa-bars navbar-toggle" id="sidebar-toggle"></i>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li>
                        <a href="#" class="active" data-page="dashboard">
                            <i class="fas fa-home"></i>
                            <span>الرئيسية</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="profile">
                            <i class="fas fa-user"></i>
                            <span>الملف الشخصي</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="classes">
                            <i class="fas fa-book"></i>
                            <span>حصصي</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="schedule">
                            <i class="fas fa-calendar-alt"></i>
                            <span>جدولي</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="payments">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>الدفعات</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="attendance">
                            <i class="fas fa-clipboard-check"></i>
                            <span>الحضور</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>تسجيل الخروج</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <nav class="navbar">
                <div class="navbar-left">
                    <div class="navbar-search">
                        <input type="text" placeholder="بحث...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <div class="navbar-right">
                    <div class="navbar-profile">
                        <img id="profile-img" src="https://via.placeholder.com/150" alt="Profile">
                        <span id="profile-name">الطالب</span>
                    </div>
                </div>
            </nav>

            <div class="content">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page-content active">
                    <div class="page-header">
                        <h2>لوحة التحكم</h2>
                        <div class="actions">
                            <button class="btn btn-primary" id="refresh-data">
                                <i class="fas fa-sync-alt"></i> تحديث البيانات
                            </button>
                        </div>
                    </div>

                    <div class="cards">
                        <div class="card">
                            <div class="card-header">
                                <h3>الحصص القادمة</h3>
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="card-body">
                                <div id="upcoming-classes-list">
                                    <p class="text-muted">جاري تحميل البيانات...</p>
                                </div>
                            </div>
                            <div class="card-footer">
                                <a href="#" data-page="schedule">عرض الكل</a>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>حالة الدفعات</h3>
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="card-body">
                                <div id="payments-status">
                                    <p class="text-muted">جاري تحميل البيانات...</p>
                                </div>
                            </div>
                            <div class="card-footer">
                                <a href="#" data-page="payments">عرض الكل</a>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>الحضور</h3>
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="card-body">
                                <div id="attendance-stats">
                                    <p class="text-muted">جاري تحميل البيانات...</p>
                                </div>
                            </div>
                            <div class="card-footer">
                                <a href="#" data-page="attendance">عرض الكل</a>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>إشعارات</h3>
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="card-body">
                            <div id="notifications-list">
                                <p class="text-muted">لا توجد إشعارات جديدة</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profile-page" class="page-content" style="display: none;">
                    <div class="page-header">
                        <h2>الملف الشخصي</h2>
                        <div class="actions">
                            <button class="btn btn-primary" id="edit-profile-btn">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card profile-card">
                                <img id="profile-image" src="https://via.placeholder.com/150" class="profile-img" alt="Profile">
                                <h3 id="student-name" class="profile-name">اسم الطالب</h3>
                                <p id="student-id" class="profile-id">ID: STU-0000</p>
                                <div id="profile-status" class="badge badge-success">نشط</div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h3>تغيير كلمة المرور</h3>
                                </div>
                                <div class="card-body">
                                    <form id="change-password-form">
                                        <div class="form-group">
                                            <label for="current-password">كلمة المرور الحالية</label>
                                            <input type="password" id="current-password" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="new-password">كلمة المرور الجديدة</label>
                                            <input type="password" id="new-password" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="confirm-password">تأكيد كلمة المرور</label>
                                            <input type="password" id="confirm-password" class="form-control" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-block" id="change-password-btn">
                                            <span id="change-password-text">تغيير كلمة المرور</span>
                                            <span id="change-password-spinner" class="spinner" style="display: none;"></span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3>معلومات الطالب</h3>
                                </div>
                                <div class="card-body">
                                    <div class="profile-details">
                                        <p>
                                            <i class="fas fa-id-card"></i>
                                            <strong>الرقم الجامعي:</strong> 
                                            <span id="profile-student-id">STU-0000</span>
                                        </p>
                                        <p>
                                            <i class="fas fa-user-graduate"></i>
                                            <strong>السنة الدراسية:</strong> 
                                            <span id="profile-academic-year">غير محدد</span>
                                        </p>
                                        <p>
                                            <i class="fas fa-birthday-cake"></i>
                                            <strong>تاريخ الميلاد:</strong> 
                                            <span id="profile-birth-date">غير محدد</span>
                                        </p>
                                        <p>
                                            <i class="fas fa-calendar-alt"></i>
                                            <strong>تاريخ التسجيل:</strong> 
                                            <span id="profile-registration-date">غير محدد</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h3>معلومات ولي الأمر</h3>
                                </div>
                                <div class="card-body">
                                    <div class="profile-details">
                                        <p>
                                            <i class="fas fa-user"></i>
                                            <strong>اسم ولي الأمر:</strong> 
                                            <span id="profile-parent-name">غير محدد</span>
                                        </p>
                                        <p>
                                            <i class="fas fa-phone"></i>
                                            <strong>هاتف ولي الأمر:</strong> 
                                            <span id="profile-parent-phone">غير محدد</span>
                                        </p>
                                        <p>
                                            <i class="fas fa-envelope"></i>
                                            <strong>بريد ولي الأمر:</strong> 
                                            <span id="profile-parent-email">غير محدد</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classes Page -->
                <div id="classes-page" class="page-content" style="display: none;">
                    <div class="page-header">
                        <h2>حصصي</h2>
                        <div class="actions">
                            <button class="btn btn-primary" id="refresh-classes">
                                <i class="fas fa-sync-alt"></i> تحديث
                            </button>
                        </div>
                    </div>

                    <div class="cards" id="classes-cards">
                        <p class="text-muted">جاري تحميل الحصص...</p>
                    </div>
                </div>

                <!-- Schedule Page -->
                <div id="schedule-page" class="page-content" style="display: none;">
                    <div class="page-header">
                        <h2>جدولي الأسبوعي</h2>
                        <div class="actions">
                            <button class="btn btn-primary" id="print-schedule">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div id="weekly-schedule">
                                <p class="text-muted">جاري تحميل الجدول...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Page -->
                <div id="payments-page" class="page-content" style="display: none;">
                    <div class="page-header">
                        <h2>الدفعات المالية</h2>
                        <div class="actions">
                            <button class="btn btn-primary" id="print-payments">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="payments-table">
                                    <thead>
                                        <tr>
                                            <th>الحصة</th>
                                            <th>الشهر</th>
                                            <th>المبلغ</th>
                                            <th>حالة الدفع</th>
                                            <th>تاريخ الدفع</th>
                                            <th>الفاتورة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center">جاري تحميل البيانات...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Page -->
                <div id="attendance-page" class="page-content" style="display: none;">
                    <div class="page-header">
                        <h2>سجل الحضور</h2>
                        <div class="actions">
                            <button class="btn btn-primary" id="print-attendance">
                                <i class="fas fa-print"></i> طباعة
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="attendance-table">
                                    <thead>
                                        <tr>
                                            <th>التاريخ</th>
                                            <th>الحصة</th>
                                            <th>الحالة</th>
                                            <th>الوقت</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="4" class="text-center">جاري تحميل البيانات...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3>تعديل الملف الشخصي</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-name">اسم الطالب الكامل</label>
                        <input type="text" id="edit-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-birth-date">تاريخ الميلاد</label>
                        <input type="date" id="edit-birth-date" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="edit-academic-year">السنة الدراسية</label>
                        <select id="edit-academic-year" class="form-control" required>
                            <option value="1AS">الأولى ثانوي</option>
                            <option value="2AS">الثانية ثانوي</option>
                            <option value="3AS">الثالثة ثانوي</option>
                            <option value="1MS">الأولى متوسط</option>
                            <option value="2MS">الثانية متوسط</option>
                            <option value="3MS">الثالثة متوسط</option>
                            <option value="4MS">الرابعة متوسط</option>
                            <option value="5MS">الخامسة متوسط</option>
                            <option value="1AP">الأولى ابتدائي</option>
                            <option value="2AP">الثانية ابتدائي</option>
                            <option value="3AP">الثالثة ابتدائي</option>
                            <option value="4AP">الرابعة ابتدائي</option>
                            <option value="5AP">الخامسة ابتدائي</option>
                            <option value="NS">غير محدد</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-parent-name">اسم ولي الأمر</label>
                        <input type="text" id="edit-parent-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-parent-phone">هاتف ولي الأمر</label>
                        <input type="tel" id="edit-parent-phone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-parent-email">بريد ولي الأمر</label>
                        <input type="email" id="edit-parent-email" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancel-edit-profile">إلغاء</button>
                <button class="btn btn-primary" id="save-profile-changes">حفظ التغييرات</button>
            </div>
        </div>
    </div>

    <!-- Payment Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3>فاتورة الدفع</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="invoice-content">
                    <p class="text-muted">جاري تحميل الفاتورة...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="print-invoice">طباعة الفاتورة</button>
                <button class="btn btn-danger" id="close-invoice">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Dark Mode Toggle -->
    <div class="dark-mode-toggle" id="dark-mode-toggle">
        <i class="fas fa-moon"></i>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let studentData = null;
        let classesData = [];
        let paymentsData = [];
        let attendanceData = [];
        
        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const app = document.getElementById('app');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const cancelRegisterBtn = document.getElementById('cancel-register');
        const logoutBtn = document.getElementById('logout-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // API Base URL
        const API_BASE_URL = 'http://localhost:4200/api';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const token = localStorage.getItem('student_token');
        const userData = localStorage.getItem('student_data');
        if (token && userData) {
            try {
            currentUser = JSON.parse(userData);
            studentData = JSON.parse(localStorage.getItem('student_profile') || 'null');
            
            // Show the app and load data
            loginPage.style.display = 'none';
            registerPage.style.display = 'none';
            app.style.display = 'block';
            
            // Load initial data
            loadInitialData();
            updateUserUI();
            } catch (e) {
            console.error('Failed to parse stored user data:', e);
            clearLocalStorage();
            showLoginPage();
            }
        } else {
            showLoginPage();
        }
        

            
            // Event listeners
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            showRegisterLink.addEventListener('click', showRegisterPage);
            cancelRegisterBtn.addEventListener('click', showLoginPage);
            logoutBtn.addEventListener('click', handleLogout);
            darkModeToggle.addEventListener('click', toggleDarkMode);
            
            // Check for dark mode preference
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Initialize sidebar navigation
            initSidebarNavigation();
            
            // Initialize page content
            initPageContent();
        });
        
        // Verify JWT token
// In your verifyToken function in the frontend
async function verifyToken(token) {
  try {
    const response = await fetch(`${API_BASE_URL}/student/data`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      // Check if it's a 403 error specifically
      if (response.status === 403) {
        // Token is invalid/expired - clear it
        localStorage.removeItem('student_token');
        window.location.href = '/student/login';
      }
      throw new Error('Failed to verify token');
    }
    
    return await response.json();
  } catch (error) {
    console.error('Token verification failed:', error);
    // Redirect to login on verification failure
    localStorage.removeItem('student_token');
    window.location.href = '/student/login';
    throw error;
  }
}
async function handleLogin(e) {
  e.preventDefault();
  
  const loginBtn = document.getElementById('login-btn');
  const loginText = document.getElementById('login-text');
  const loginSpinner = document.getElementById('login-spinner');
  const loginAlert = document.getElementById('login-alert');

  // Show loading state
  loginText.style.display = 'none';
  loginSpinner.style.display = 'inline-block';
  loginAlert.style.display = 'none';

  try {
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
      })
    });

    const data = await response.json();
    
    if (response.ok) {
      // Store token and user data
      localStorage.setItem('student_token', data.token);
      localStorage.setItem('student_data', JSON.stringify(data.user));
      
      // Set current user
      currentUser = data.user;
      
      // Load student data if available
      if (data.user.student) {
        studentData = data.user.student;
        localStorage.setItem('student_profile', JSON.stringify(data.user.student));
      }
      
      // Redirect to dashboard
      onLoginSuccess();
    } else {
      throw new Error(data.error || 'Login failed');
    }
  } catch (error) {
    console.error('Login failed:', error);
    loginAlert.textContent = error.message;
    loginAlert.style.display = 'block';
  } finally {
    // Reset loading state
    loginText.style.display = 'inline-block';
    loginSpinner.style.display = 'none';
  }
}

async function handleRegister(e) {
            e.preventDefault();
            
            const registerBtn = document.getElementById('register-btn');
            const registerText = document.getElementById('register-text');
            const registerSpinner = document.getElementById('register-spinner');
            const registerAlert = document.getElementById('register-alert');
            
            // Show loading state
            registerText.style.display = 'none';
            registerSpinner.style.display = 'inline-block';
            registerAlert.style.display = 'none';
            
            try {
                const registrationData = {
                    name: document.getElementById('name').value,
                    birthDate: document.getElementById('birthDate').value,
                    academicYear: document.getElementById('academicYear').value,
                    parentName: document.getElementById('parentName').value,
                    parentPhone: document.getElementById('parentPhone').value,
                    parentEmail: document.getElementById('parentEmail').value,
                    address: document.getElementById('address').value,
                    previousSchool: document.getElementById('previousSchool').value,
                    healthInfo: document.getElementById('healthInfo').value
                };
                
                const response = await fetch(`${API_BASE_URL}/student/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registrationData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    registerAlert.textContent = 'تم إرسال طلب الانضمام بنجاح، سيتم مراجعته من قبل الإدارة';
                    registerAlert.classList.remove('alert-danger');
                    registerAlert.classList.add('alert-success');
                    registerAlert.style.display = 'block';
                    
                    // Clear form
                    registerForm.reset();
                    
                    // Show login page after 3 seconds
                    setTimeout(() => {
                        showLoginPage();
                    }, 3000);
                } else {
                    throw new Error(data.error || 'فشل إرسال الطلب');
                }
            } catch (error) {
                registerAlert.textContent = error.message;
                registerAlert.classList.remove('alert-success');
                registerAlert.classList.add('alert-danger');
                registerAlert.style.display = 'block';
            } finally {
                // Reset loading state
                registerText.style.display = 'inline-block';
                registerSpinner.style.display = 'none';
            }
        }
        
        // Handle logout
        function handleLogout() {
  clearLocalStorage();
  currentUser = null;
  studentData = null;
  showLoginPage();
  
  // Reset URL
  window.history.pushState({}, '', '/student/login');
}
        // Show login page
        function showLoginPage() {
            loginPage.style.display = 'flex';
            registerPage.style.display = 'none';
            app.style.display = 'none';
            
            // Clear login form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-alert').style.display = 'none';
        }
        
        // Show register page
        function showRegisterPage(e) {
            e.preventDefault();
            loginPage.style.display = 'none';
            registerPage.style.display = 'flex';
            app.style.display = 'none';
            
            // Clear register form
            registerForm.reset();
            document.getElementById('register-alert').style.display = 'none';
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('darkMode', 'disabled');
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // Initialize sidebar navigation
        function initSidebarNavigation() {
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a[data-page]');
            
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Hide all pages
                    const pages = document.querySelectorAll('.page-content');
                    pages.forEach(page => page.style.display = 'none');
                    
                    // Show selected page
                    const pageId = `${this.getAttribute('data-page')}-page`;
                    document.getElementById(pageId).style.display = 'block';
                    
                    // Load page data if needed
                    switch(this.getAttribute('data-page')) {
                        case 'dashboard':
                            loadDashboardData();
                            break;
                        case 'classes':
                            loadClassesData();
                            break;
                        case 'schedule':
                            loadScheduleData();
                            break;
                        case 'payments':
                            loadPaymentsData();
                            break;
                        case 'attendance':
                            loadAttendanceData();
                            break;
                    }
                });
            });
            
            // Toggle sidebar on mobile
            const sidebarToggle = document.getElementById('sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.querySelector('.sidebar').classList.toggle('active');
                });
            }
        }
        
        // Initialize page content
        function initPageContent() {
            // Profile page events
            document.getElementById('edit-profile-btn').addEventListener('click', showEditProfileModal);
            document.getElementById('save-profile-changes').addEventListener('click', saveProfileChanges);
            document.getElementById('cancel-edit-profile').addEventListener('click', closeEditProfileModal);
            document.querySelector('#edit-profile-modal .close').addEventListener('click', closeEditProfileModal);
            
            // Change password form
            document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
            
            // Invoice modal events
            document.querySelector('#invoice-modal .close').addEventListener('click', closeInvoiceModal);
            document.getElementById('close-invoice').addEventListener('click', closeInvoiceModal);
            document.getElementById('print-invoice').addEventListener('click', printInvoice);
            
            // Refresh buttons
            document.getElementById('refresh-data').addEventListener('click', loadInitialData);
            document.getElementById('refresh-classes').addEventListener('click', loadClassesData);
            
            // Print buttons
            document.getElementById('print-schedule').addEventListener('click', printSchedule);
            document.getElementById('print-payments').addEventListener('click', printPayments);
            document.getElementById('print-attendance').addEventListener('click', printAttendance);
        }
        
        // Load student data
        function loadStudentData() {
            if (!studentData) return;
            
            // Profile image
            const profileImg = document.getElementById('profile-img');
            const profileImage = document.getElementById('profile-image');
            
            // Generate initials if no image
            const nameParts = studentData.name.split(' ');
            const initials = nameParts[0].charAt(0) + (nameParts.length > 1 ? nameParts[1].charAt(0) : '');
            
            // Create canvas for profile image
            const canvas = document.createElement('canvas');
            canvas.width = 150;
            canvas.height = 150;
            const ctx = canvas.getContext('2d');
            
            // Fill background
            ctx.fillStyle = getRandomColor();
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw text
            ctx.fillStyle = '#ffffff';
            ctx.font = '60px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials, canvas.width / 2, canvas.height / 2);
            
            // Set image source
            const dataUrl = canvas.toDataURL();
            profileImg.src = dataUrl;
            profileImage.src = dataUrl;
            
            // Profile name
            document.getElementById('profile-name').textContent = studentData.name;
            document.getElementById('student-name').textContent = studentData.name;
            document.getElementById('profile-student-name').textContent = studentData.name;
            
            // Student ID
            document.getElementById('student-id').textContent = studentData.studentId || 'غير محدد';
            document.getElementById('profile-student-id').textContent = studentData.studentId || 'غير محدد';
            
            // Academic year
            const academicYearMap = {
                '1AS': 'الأولى ثانوي',
                '2AS': 'الثانية ثانوي',
                '3AS': 'الثالثة ثانوي',
                '1MS': 'الأولى متوسط',
                '2MS': 'الثانية متوسط',
                '3MS': 'الثالثة متوسط',
                '4MS': 'الرابعة متوسط',
                '5MS': 'الخامسة متوسط',
                '1AP': 'الأولى ابتدائي',
                '2AP': 'الثانية ابتدائي',
                '3AP': 'الثالثة ابتدائي',
                '4AP': 'الرابعة ابتدائي',
                '5AP': 'الخامسة ابتدائي',
                'NS': 'غير محدد'
            };
            
            document.getElementById('profile-academic-year').textContent = 
                academicYearMap[studentData.academicYear] || 'غير محدد';
            
            // Birth date
            document.getElementById('profile-birth-date').textContent = 
                studentData.birthDate ? new Date(studentData.birthDate).toLocaleDateString('ar-EG') : 'غير محدد';
            
            // Registration date
            document.getElementById('profile-registration-date').textContent = 
                studentData.registrationDate ? new Date(studentData.registrationDate).toLocaleDateString('ar-EG') : 'غير محدد';
            
            // Parent info
            document.getElementById('profile-parent-name').textContent = studentData.parentName || 'غير محدد';
            document.getElementById('profile-parent-phone').textContent = studentData.parentPhone || 'غير محدد';
            document.getElementById('profile-parent-email').textContent = studentData.parentEmail || 'غير محدد';
            
            // Status
            const statusElement = document.getElementById('profile-status');
            if (studentData.active) {
                statusElement.textContent = 'نشط';
                statusElement.className = 'badge badge-success';
            } else {
                statusElement.textContent = 'غير نشط';
                statusElement.className = 'badge badge-danger';
            }
            
        }
        
        // Load initial data
// In your loadInitialData function
async function loadInitialData() {
  try {
    const token = localStorage.getItem('student_token');
    if (!token) throw new Error('No token found');
    
    const response = await fetch(`${API_BASE_URL}/student/data`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to load data');
    }
    
    const data = await response.json();
    // Process the data...
  } catch (error) {
    console.error('Failed to load initial data:', error);
    showAlert('error', error.message || 'Failed to load data');
    // Optionally redirect to login if token is invalid
    if (error.message.includes('token') || error.message.includes('authorization')) {
      handleLogout();
    }
  }
}
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load upcoming classes
                const upcomingClassesList = document.getElementById('upcoming-classes-list');
                upcomingClassesList.innerHTML = '<p class="text-muted">جاري تحميل الحصص القادمة...</p>';
                
                if (studentData && studentData.upcomingClasses) {
                    if (studentData.upcomingClasses.length > 0) {
                        let html = '';
                        studentData.upcomingClasses.slice(0, 3).forEach(cls => {
                            html += `
                                <div class="class-item mb-2">
                                    <strong>${cls.className}</strong> - ${cls.subject}<br>
                                    <small>${cls.day} - ${cls.time}</small>
                                </div>
                            `;
                        });
                        
                        if (studentData.upcomingClasses.length > 3) {
                            html += `<small>و ${studentData.upcomingClasses.length - 3} حصص أخرى</small>`;
                        }
                        
                        upcomingClassesList.innerHTML = html;
                    } else {
                        upcomingClassesList.innerHTML = '<p class="text-muted">لا توجد حصص قادمة</p>';
                    }
                }
                
                // Load payments status
                const paymentsStatus = document.getElementById('payments-status');
                paymentsStatus.innerHTML = '<p class="text-muted">جاري تحميل حالة الدفعات...</p>';
                
                if (studentData && studentData.payments) {
                    const paidCount = studentData.payments.filter(p => p.status === 'paid').length;
                    const pendingCount = studentData.payments.filter(p => p.status === 'pending').length;
                    const lateCount = studentData.payments.filter(p => p.status === 'late').length;
                    
                    paymentsStatus.innerHTML = `
                        <div class="mb-2">
                            <span class="badge badge-success">${paidCount} مدفوعة</span>
                        </div>
                        <div class="mb-2">
                            <span class="badge badge-warning">${pendingCount} معلقة</span>
                        </div>
                        <div>
                            <span class="badge badge-danger">${lateCount} متأخرة</span>
                        </div>
                    `;
                }
                
                // Load attendance stats
                const attendanceStats = document.getElementById('attendance-stats');
                attendanceStats.innerHTML = '<p class="text-muted">جاري تحميل إحصائيات الحضور...</p>';
                
                if (studentData && studentData.attendance) {
                    const presentCount = studentData.attendance.filter(a => a.status === 'present').length;
                    const absentCount = studentData.attendance.filter(a => a.status === 'absent').length;
                    const lateCount = studentData.attendance.filter(a => a.status === 'late').length;
                    const total = presentCount + absentCount + lateCount;
                    const attendanceRate = total > 0 ? Math.round((presentCount / total) * 100) : 0;
                    
                    attendanceStats.innerHTML = `
                        <div class="mb-2">
                            <span>معدل الحضور: <strong>${attendanceRate}%</strong></span>
                        </div>
                        <div class="mb-2">
                            <span class="badge badge-success">${presentCount} حضور</span>
                        </div>
                        <div class="mb-2">
                            <span class="badge badge-danger">${absentCount} غياب</span>
                        </div>
                        <div>
                            <span class="badge badge-warning">${lateCount} تأخر</span>
                        </div>
                    `;
                }
                
                // Load notifications
                const notificationsList = document.getElementById('notifications-list');
                notificationsList.innerHTML = '<p class="text-muted">جاري تحميل الإشعارات...</p>';
                
                // Simulate notifications
                setTimeout(() => {
                    notificationsList.innerHTML = `
                        <div class="notification-item mb-2">
                            <i class="fas fa-info-circle text-primary"></i> تم تسجيل حضورك في حصة الرياضيات اليوم
                            <small class="text-muted d-block">منذ ساعة</small>
                        </div>
                        <div class="notification-item mb-2">
                            <i class="fas fa-money-bill-wave text-success"></i> تم تسجيل دفعة شهر مارس بنجاح
                            <small class="text-muted d-block">منذ 3 أيام</small>
                        </div>
                        <div class="notification-item">
                            <i class="fas fa-calendar-alt text-info"></i> لديك حصة فيزياء غداً في الساعة 10:00 صباحاً
                            <small class="text-muted d-block">منذ 5 أيام</small>
                        </div>
                    `;
                }, 1000);
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showAlert('error', 'فشل تحميل بيانات لوحة التحكم');
            }
        }
        
        // Load classes data
        async function loadClassesData() {
            try {
                const classesCards = document.getElementById('classes-cards');
                classesCards.innerHTML = '<p class="text-muted">جاري تحميل الحصص...</p>';
                
                const response = await fetch(`${API_BASE_URL}/student/data`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    classesData = data.student.classes || [];
                    
                    if (classesData.length > 0) {
                        let html = '';
                        
                        classesData.forEach(cls => {
                            const teacherName = cls.teacher ? cls.teacher.name : 'غير محدد';
                            const scheduleText = cls.schedule && cls.schedule.length > 0 
                                ? cls.schedule.map(s => `${s.day} - ${s.time}`).join('<br>')
                                : 'غير محدد';
                            
                            html += `
                                <div class="card class-card">
                                    <div class="card-header">
                                        <h3>${cls.name}</h3>
                                        <span class="badge ${cls.subject === 'رياضيات' ? 'badge-primary' : 
                                            cls.subject === 'فيزياء' ? 'badge-secondary' : 
                                            cls.subject === 'علوم' ? 'badge-success' : 'badge-info'}">
                                            ${cls.subject}
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>الأستاذ:</strong> ${teacherName}</p>
                                        <p><strong>الجدول:</strong> ${scheduleText}</p>
                                        <p><strong>السعر:</strong> ${cls.price} د.ك/شهر</p>
                                    </div>
                                    <div class="card-footer">
                                        <small>${cls.academicYear}</small>
                                        <a href="#" data-page="schedule">عرض الجدول</a>
                                    </div>
                                </div>
                            `;
                        });
                        
                        classesCards.innerHTML = html;
                    } else {
                        classesCards.innerHTML = '<p class="text-muted">لا توجد حصص مسجلة</p>';
                    }
                } else {
                    throw new Error('Failed to load classes data');
                }
            } catch (error) {
                console.error('Failed to load classes data:', error);
                showAlert('error', 'فشل تحميل بيانات الحصص');
            }
        }
        
        // Load schedule data
        async function loadScheduleData() {
            try {
                const weeklySchedule = document.getElementById('weekly-schedule');
                weeklySchedule.innerHTML = '<p class="text-muted">جاري تحميل الجدول الأسبوعي...</p>';
                
                if (classesData.length > 0) {
                    // Group classes by day
                    const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                    const scheduleByDay = {};
                    
                    days.forEach(day => {
                        scheduleByDay[day] = [];
                    });
                    
                    classesData.forEach(cls => {
                        if (cls.schedule && cls.schedule.length > 0) {
                            cls.schedule.forEach(session => {
                                if (days.includes(session.day)) {
                                    scheduleByDay[session.day].push({
                                        className: cls.name,
                                        subject: cls.subject,
                                        time: session.time,
                                        teacher: cls.teacher ? cls.teacher.name : 'غير محدد',
                                        classroom: session.classroom ? session.classroom.name : 'غير محدد'
                                    });
                                }
                            });
                        }
                    });
                    
                    // Sort classes by time within each day
                    days.forEach(day => {
                        scheduleByDay[day].sort((a, b) => {
                            const timeA = a.time.split(':').map(Number);
                            const timeB = b.time.split(':').map(Number);
                            return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                        });
                    });
                    
                    // Generate schedule HTML
                    let html = '<div class="table-responsive"><table class="table"><thead><tr>';
                    
                    days.forEach(day => {
                        html += `<th>${day}</th>`;
                    });
                    
                    html += '</tr></thead><tbody><tr>';
                    
                    days.forEach(day => {
                        html += '<td>';
                        
                        if (scheduleByDay[day].length > 0) {
                            scheduleByDay[day].forEach(cls => {
                                html += `
                                    <div class="class-schedule-item mb-3">
                                        <strong>${cls.className}</strong><br>
                                        <small>${cls.subject} - ${cls.time}</small><br>
                                        <small>الأستاذ: ${cls.teacher}</small><br>
                                        <small>القاعة: ${cls.classroom}</small>
                                    </div>
                                `;
                            });
                        } else {
                            html += '<p class="text-muted">لا توجد حصص</p>';
                        }
                        
                        html += '</td>';
                    });
                    
                    html += '</tr></tbody></table></div>';
                    weeklySchedule.innerHTML = html;
                } else {
                    weeklySchedule.innerHTML = '<p class="text-muted">لا توجد حصص مسجلة</p>';
                }
            } catch (error) {
                console.error('Failed to load schedule data:', error);
                showAlert('error', 'فشل تحميل بيانات الجدول');
            }
        }
        
        // Load payments data
        async function loadPaymentsData() {
            try {
                const paymentsTable = document.getElementById('payments-table');
                const tbody = paymentsTable.querySelector('tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">جاري تحميل البيانات...</td></tr>';
                
                const response = await fetch(`${API_BASE_URL}/student/data`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    paymentsData = data.payments || [];
                    
                    if (paymentsData.length > 0) {
                        let html = '';
                        
                        paymentsData.forEach(payment => {
                            const statusBadge = payment.status === 'paid' ? 'badge-success' : 
                                              payment.status === 'pending' ? 'badge-warning' : 'badge-danger';
                            
                            const paymentDate = payment.paymentDate ? 
                                new Date(payment.paymentDate).toLocaleDateString('ar-EG') : '---';
                                
                            const invoiceBtn = payment.status === 'paid' ? 
                                `<button class="btn btn-sm btn-primary view-invoice" data-id="${payment._id}">عرض</button>` : 
                                '---';
                            
                            html += `
                                <tr>
                                    <td>${payment.class.name}</td>
                                    <td>${payment.month}</td>
                                    <td>${payment.amount} د.ك</td>
                                    <td><span class="badge ${statusBadge}">${payment.status === 'paid' ? 'مدفوعة' : 
                                        payment.status === 'pending' ? 'معلقة' : 'متأخرة'}</span></td>
                                    <td>${paymentDate}</td>
                                    <td>${invoiceBtn}</td>
                                </tr>
                            `;
                        });
                        
                        tbody.innerHTML = html;
                        
                        // Add event listeners to invoice buttons
                        document.querySelectorAll('.view-invoice').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.preventDefault();
                                const paymentId = this.getAttribute('data-id');
                                viewInvoice(paymentId);
                            });
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">لا توجد دفعات</td></tr>';
                    }
                } else {
                    throw new Error('Failed to load payments data');
                }
            } catch (error) {
                console.error('Failed to load payments data:', error);
                showAlert('error', 'فشل تحميل بيانات الدفعات');
            }
        }
        
        // Load attendance data
        async function loadAttendanceData() {
            try {
                const attendanceTable = document.getElementById('attendance-table');
                const tbody = attendanceTable.querySelector('tbody');
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">جاري تحميل البيانات...</td></tr>';
                
                const response = await fetch(`${API_BASE_URL}/student/data`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    attendanceData = data.attendance || [];
                    
                    if (attendanceData.length > 0) {
                        let html = '';
                        
                        attendanceData.forEach(record => {
                            const statusBadge = record.status === 'present' ? 'badge-success' : 
                                              record.status === 'absent' ? 'badge-danger' : 'badge-warning';
                            
                            html += `
                                <tr>
                                    <td>${new Date(record.date).toLocaleDateString('ar-EG')}</td>
                                    <td>${record.class.name}</td>
                                    <td><span class="badge ${statusBadge}">${record.status === 'present' ? 'حضور' : 
                                        record.status === 'absent' ? 'غياب' : 'تأخر'}</span></td>
                                    <td>${new Date(record.date).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}</td>
                                </tr>
                            `;
                        });
                        
                        tbody.innerHTML = html;
                    } else {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد سجلات حضور</td></tr>';
                    }
                } else {
                    throw new Error('Failed to load attendance data');
                }
            } catch (error) {
                console.error('Failed to load attendance data:', error);
                showAlert('error', 'فشل تحميل بيانات الحضور');
            }
        }
        
        // Show edit profile modal
        function showEditProfileModal() {
            if (!studentData) return;
            
            document.getElementById('edit-name').value = studentData.name;
            document.getElementById('edit-birth-date').value = studentData.birthDate ? 
                new Date(studentData.birthDate).toISOString().split('T')[0] : '';
            document.getElementById('edit-academic-year').value = studentData.academicYear || 'NS';
            document.getElementById('edit-parent-name').value = studentData.parentName || '';
            document.getElementById('edit-parent-phone').value = studentData.parentPhone || '';
            document.getElementById('edit-parent-email').value = studentData.parentEmail || '';
            
            document.getElementById('edit-profile-modal').style.display = 'block';
        }
        
        // Close edit profile modal
        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').style.display = 'none';
        }
        
        // Save profile changes
        async function saveProfileChanges() {
            try {
                const saveBtn = document.getElementById('save-profile-changes');
                const saveText = saveBtn.textContent;
                
                // Show loading state
                saveBtn.innerHTML = '<span class="spinner"></span> جاري الحفظ...';
                saveBtn.disabled = true;
                
                const updatedData = {
                    name: document.getElementById('edit-name').value,
                    birthDate: document.getElementById('edit-birth-date').value,
                    academicYear: document.getElementById('edit-academic-year').value,
                    parentName: document.getElementById('edit-parent-name').value,
                    parentPhone: document.getElementById('edit-parent-phone').value,
                    parentEmail: document.getElementById('edit-parent-email').value
                };
                
                const response = await fetch(`${API_BASE_URL}/students/${studentData._id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify(updatedData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    studentData = data;
                    loadStudentData();
                    closeEditProfileModal();
                    showAlert('success', 'تم تحديث الملف الشخصي بنجاح');
                } else {
                    throw new Error('Failed to update profile');
                }
            } catch (error) {
                console.error('Failed to save profile changes:', error);
                showAlert('error', 'فشل تحديث الملف الشخصي');
            } finally {
                // Reset button state
                const saveBtn = document.getElementById('save-profile-changes');
                saveBtn.textContent = saveText;
                saveBtn.disabled = false;
            }
        }
        
        // Handle change password
        async function handleChangePassword(e) {
            e.preventDefault();
            
            try {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (newPassword !== confirmPassword) {
                    throw new Error('كلمة المرور الجديدة غير متطابقة');
                }
                
                const changeBtn = document.getElementById('change-password-btn');
                const changeText = document.getElementById('change-password-text');
                const changeSpinner = document.getElementById('change-password-spinner');
                
                // Show loading state
                changeText.style.display = 'none';
                changeSpinner.style.display = 'inline-block';
                
                const response = await fetch(`${API_BASE_URL}/student/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                if (response.ok) {
                    showAlert('success', 'تم تغيير كلمة المرور بنجاح');
                    document.getElementById('change-password-form').reset();
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'فشل تغيير كلمة المرور');
                }
            } catch (error) {
                console.error('Failed to change password:', error);
                showAlert('error', error.message);
            } finally {
                // Reset loading state
                const changeText = document.getElementById('change-password-text');
                const changeSpinner = document.getElementById('change-password-spinner');
                changeText.style.display = 'inline-block';
                changeSpinner.style.display = 'none';
            }
        }
        
        // View invoice
        async function viewInvoice(paymentId) {
            try {
                const invoiceContent = document.getElementById('invoice-content');
                invoiceContent.innerHTML = '<p class="text-muted">جاري تحميل الفاتورة...</p>';
                
                document.getElementById('invoice-modal').style.display = 'block';
                
                const payment = paymentsData.find(p => p._id === paymentId);
                if (!payment) {
                    throw new Error('Payment not found');
                }
                
                // Generate invoice HTML
                const invoiceDate = payment.paymentDate ? 
                    new Date(payment.paymentDate).toLocaleDateString('ar-EG') : new Date().toLocaleDateString('ar-EG');
                
                const invoiceHTML = `
                    <div class="text-center mb-4">
                        <h3>فاتورة الدفع</h3>
                        <p>نظام إدارة الطلاب</p>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>اسم الطالب:</strong> ${studentData.name}</p>
                            <p><strong>الرقم الجامعي:</strong> ${studentData.studentId}</p>
                        </div>
                        <div class="col-md-6 text-left">
                            <p><strong>رقم الفاتورة:</strong> ${payment.invoiceNumber || 'INV-' + Date.now()}</p>
                            <p><strong>تاريخ الفاتورة:</strong> ${invoiceDate}</p>
                        </div>
                    </div>
                    
                    <table class="table mb-4">
                        <thead>
                            <tr>
                                <th>الوصف</th>
                                <th>المبلغ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>دفعة شهر ${payment.month} - ${payment.class.name}</td>
                                <td>${payment.amount} د.ك</td>
                            </tr>
                            <tr>
                                <td><strong>الإجمالي</strong></td>
                                <td><strong>${payment.amount} د.ك</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <p><strong>طريقة الدفع:</strong> ${payment.paymentMethod === 'cash' ? 'نقداً' : 
                              payment.paymentMethod === 'bank' ? 'تحويل بنكي' : 'دفع إلكتروني'}</p>
                        </div>
                        <div class="col-md-6 text-left">
                            <p><strong>حالة الدفع:</strong> <span class="badge badge-success">مدفوعة</span></p>
                        </div>
                    </div>
                    
                    <div class="mt-5 pt-4 border-top">
                        <p class="text-center text-muted">شكراً لثقتكم بنا</p>
                    </div>
                `;
                
                invoiceContent.innerHTML = invoiceHTML;
                
                // Set payment ID for printing
                document.getElementById('print-invoice').setAttribute('data-id', paymentId);
            } catch (error) {
                console.error('Failed to load invoice:', error);
                invoiceContent.innerHTML = '<p class="text-danger">فشل تحميل الفاتورة</p>';
            }
        }
        
        // Close invoice modal
        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }
        
        // Print invoice
        function printInvoice() {
            const printWindow = window.open('', '_blank');
            const paymentId = this.getAttribute('data-id');
            const payment = paymentsData.find(p => p._id === paymentId);
            
            if (!payment) return;
            
            const invoiceDate = payment.paymentDate ? 
                new Date(payment.paymentDate).toLocaleDateString('ar-EG') : new Date().toLocaleDateString('ar-EG');
            
            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>فاتورة الدفع</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
                        .container { max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { margin: 0; font-size: 24px; }
                        .invoice-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 10px; border: 1px solid #ddd; text-align: right; }
                        th { background-color: #f5f5f5; }
                        .total { font-weight: bold; }
                        .footer { margin-top: 30px; text-align: center; font-size: 14px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>فاتورة الدفع</h1>
                            <p>نظام إدارة الطلاب</p>
                        </div>
                        
                        <div class="invoice-info">
                            <div>
                                <p><strong>اسم الطالب:</strong> ${studentData.name}</p>
                                <p><strong>الرقم الجامعي:</strong> ${studentData.studentId}</p>
                            </div>
                            <div>
                                <p><strong>رقم الفاتورة:</strong> ${payment.invoiceNumber || 'INV-' + Date.now()}</p>
                                <p><strong>تاريخ الفاتورة:</strong> ${invoiceDate}</p>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>الوصف</th>
                                    <th>المبلغ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>دفعة شهر ${payment.month} - ${payment.class.name}</td>
                                    <td>${payment.amount} د.ك</td>
                                </tr>
                                <tr class="total">
                                    <td>الإجمالي</td>
                                    <td>${payment.amount} د.ك</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div>
                            <p><strong>طريقة الدفع:</strong> ${payment.paymentMethod === 'cash' ? 'نقداً' : 
                              payment.paymentMethod === 'bank' ? 'تحويل بنكي' : 'دفع إلكتروني'}</p>
                            <p><strong>حالة الدفع:</strong> مدفوعة</p>
                        </div>
                        
                        <div class="footer">
                            <p>شكراً لثقتكم بنا</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Print schedule
        function printSchedule() {
            const printWindow = window.open('', '_blank');
            
            const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            const scheduleByDay = {};
            
            days.forEach(day => {
                scheduleByDay[day] = [];
            });
            
            classesData.forEach(cls => {
                if (cls.schedule && cls.schedule.length > 0) {
                    cls.schedule.forEach(session => {
                        if (days.includes(session.day)) {
                            scheduleByDay[session.day].push({
                                className: cls.name,
                                subject: cls.subject,
                                time: session.time,
                                teacher: cls.teacher ? cls.teacher.name : 'غير محدد',
                                classroom: session.classroom ? session.classroom.name : 'غير محدد'
                            });
                        }
                    });
                }
            });
            
            // Sort classes by time within each day
            days.forEach(day => {
                scheduleByDay[day].sort((a, b) => {
                    const timeA = a.time.split(':').map(Number);
                    const timeB = b.time.split(':').map(Number);
                    return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                });
            });
            
            // Generate print content
            let scheduleContent = '';
            
            days.forEach(day => {
                if (scheduleByDay[day].length > 0) {
                    scheduleContent += `<h3>${day}</h3><ul>`;
                    
                    scheduleByDay[day].forEach(cls => {
                        scheduleContent += `
                            <li>
                                <strong>${cls.className}</strong> (${cls.subject})<br>
                                الوقت: ${cls.time}<br>
                                الأستاذ: ${cls.teacher}<br>
                                القاعة: ${cls.classroom}
                            </li>
                        `;
                    });
                    
                    scheduleContent += '</ul>';
                }
            });
            
            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>جدولي الأسبوعي</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
                        h1 { text-align: center; margin-bottom: 30px; }
                        h3 { margin-top: 20px; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                        ul { list-style-type: none; padding: 0; }
                        li { background-color: #f9f9f9; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
                        strong { color: #2c3e50; }
                        .student-info { margin-bottom: 30px; text-align: center; }
                        .print-date { text-align: left; font-size: 14px; color: #666; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="print-date">${new Date().toLocaleDateString('ar-EG')}</div>
                    <h1>جدولي الأسبوعي</h1>
                    
                    <div class="student-info">
                        <p><strong>اسم الطالب:</strong> ${studentData.name}</p>
                        <p><strong>الرقم الجامعي:</strong> ${studentData.studentId}</p>
                        <p><strong>السنة الدراسية:</strong> ${studentData.academicYear}</p>
                    </div>
                    
                    ${scheduleContent}
                </body>
                </html>
            `;
            
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Print payments
        function printPayments() {
            const printWindow = window.open('', '_blank');
            
            let paymentsContent = '';
            
            if (paymentsData.length > 0) {
                paymentsContent = `
                    <table>
                        <thead>
                            <tr>
                                <th>الحصة</th>
                                <th>الشهر</th>
                                <th>المبلغ</th>
                                <th>حالة الدفع</th>
                                <th>تاريخ الدفع</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                paymentsData.forEach(payment => {
                    const paymentDate = payment.paymentDate ? 
                        new Date(payment.paymentDate).toLocaleDateString('ar-EG') : '---';
                    
                    const statusText = payment.status === 'paid' ? 'مدفوعة' : 
                                      payment.status === 'pending' ? 'معلقة' : 'متأخرة';
                    
                    paymentsContent += `
                        <tr>
                            <td>${payment.class.name}</td>
                            <td>${payment.month}</td>
                            <td>${payment.amount} د.ك</td>
                            <td>${statusText}</td>
                            <td>${paymentDate}</td>
                        </tr>
                    `;
                });
                
                paymentsContent += `
                        </tbody>
                    </table>
                `;
            } else {
                paymentsContent = '<p>لا توجد دفعات</p>';
            }
            
            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>سجل الدفعات</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
                        h1 { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 8px; border: 1px solid #ddd; text-align: right; }
                        th { background-color: #f5f5f5; }
                        .student-info { margin-bottom: 30px; text-align: center; }
                        .print-date { text-align: left; font-size: 14px; color: #666; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="print-date">${new Date().toLocaleDateString('ar-EG')}</div>
                    <h1>سجل الدفعات</h1>
                    
                    <div class="student-info">
                        <p><strong>اسم الطالب:</strong> ${studentData.name}</p>
                        <p><strong>الرقم الجامعي:</strong> ${studentData.studentId}</p>
                    </div>
                    
                    ${paymentsContent}
                </body>
                </html>
            `;
            
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Print attendance
        function printAttendance() {
            const printWindow = window.open('', '_blank');
            
            let attendanceContent = '';
            
            if (attendanceData.length > 0) {
                attendanceContent = `
                    <table>
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الحصة</th>
                                <th>الحالة</th>
                                <th>الوقت</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                attendanceData.forEach(record => {
                    const statusText = record.status === 'present' ? 'حضور' : 
                                      record.status === 'absent' ? 'غياب' : 'تأخر';
                    
                    attendanceContent += `
                        <tr>
                            <td>${new Date(record.date).toLocaleDateString('ar-EG')}</td>
                            <td>${record.class.name}</td>
                            <td>${statusText}</td>
                            <td>${new Date(record.date).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}</td>
                        </tr>
                    `;
                });
                
                attendanceContent += `
                        </tbody>
                    </table>
                `;
            } else {
                attendanceContent = '<p>لا توجد سجلات حضور</p>';
            }
            
            const printContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>سجل الحضور</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
                        h1 { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { padding: 8px; border: 1px solid #ddd; text-align: right; }
                        th { background-color: #f5f5f5; }
                        .student-info { margin-bottom: 30px; text-align: center; }
                        .print-date { text-align: left; font-size: 14px; color: #666; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="print-date">${new Date().toLocaleDateString('ar-EG')}</div>
                    <h1>سجل الحضور</h1>
                    
                    <div class="student-info">
                        <p><strong>اسم الطالب:</strong> ${studentData.name}</p>
                        <p><strong>الرقم الجامعي:</strong> ${studentData.studentId}</p>
                    </div>
                    
                    ${attendanceContent}
                </body>
                </html>
            `;
            
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Show alert
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                   type === 'error' ? 'times-circle' : 
                                   type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            
            // Prepend to content
            const content = document.querySelector('.content');
            content.insertBefore(alert, content.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Get random color for profile image
        function getRandomColor() {
            const colors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#34495e', '#16a085', '#c0392b'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }


        function handleRoute() {
  const path = window.location.pathname;
  
  if (path.includes('/dashboard')) {
    showDashboard();
  } else if (path.includes('/profile')) {
    showProfile();
  }
  // Add other routes as needed
}

window.addEventListener('load', handleRoute);
window.addEventListener('popstate', handleRoute);







function onLoginSuccess() {
  // Hide login/register pages and show app
  loginPage.style.display = 'none';
  registerPage.style.display = 'none';
  app.style.display = 'block';
  
  // Update URL
  window.history.pushState({}, '', '/student/dashboard');
  
  // Load initial data
  loadInitialData();
  
  // Update UI with user data
  updateUserUI();
}


  // Check for existing session on page load
function checkExistingSession() {
  const token = localStorage.getItem('student_token');
  const userData = localStorage.getItem('student_data');
  const studentProfile = localStorage.getItem('student_profile');
  
  if (token && userData) {
    try {
      currentUser = JSON.parse(userData);
      
      if (studentProfile) {
        studentData = JSON.parse(studentProfile);
      }
      
      // Verify token is still valid
      verifyToken(token)
        .then(() => {
          onLoginSuccess();
        })
        .catch(() => {
          // Token is invalid, clear storage
          clearLocalStorage();
          showLoginPage();
        });
    } catch (e) {
      clearLocalStorage();
      showLoginPage();
    }
  } else {
    showLoginPage();
  }
}

function clearLocalStorage() {
  localStorage.removeItem('student_token');
  localStorage.removeItem('student_data');
  localStorage.removeItem('student_profile');
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', function() {
  checkExistingSession();
  // ... rest of your existing DOMContentLoaded code
});
function updateUserUI() {
  if (!currentUser) return;
  
  // Update profile name in navbar
  document.getElementById('profile-name').textContent = currentUser.fullName || currentUser.username;
  
  // If we have student data, load it
  if (studentData) {
    loadStudentData();
  } else {
    // Try to fetch student data if we don't have it
    fetchStudentData();
  }
}

async function fetchStudentData() {
  try {
    const response = await fetch(`${API_BASE_URL}/student/data`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('student_token')}`
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      studentData = data.student;
      localStorage.setItem('student_profile', JSON.stringify(data.student));
      loadStudentData();
    }
  } catch (error) {
    console.error('Failed to fetch student data:', error);
  }
}

    </script>

</body>
</html>